#!/usr/bin/env ruby

require_relative '../config/environment'
require 'daemons'

QUERY = { q: '*:*', sort: 'timestamp asc', fl: 'id', rows: '500' }

Daemons.run_proc('rolling index') do
  loop do
    solr_conn = RSolr.connect(timeout: 120, open_timeout: 120, url: Settings.solrizer_url)
    indexer = Indexer.new(solr: solr_conn)

    response = solr_conn.get 'select', params: QUERY
    response['response']['docs'].each do |doc|
      puts "Doc #{doc}"
      indexer.reindex_pid(doc['id'], add_attributes: { commitWithin: 1000 })
    end
    sleep(5)
  end
end
